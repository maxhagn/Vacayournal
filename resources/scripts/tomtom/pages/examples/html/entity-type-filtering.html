<!DOCTYPE html>
<html class='use-all-space'>
<head>
    <meta http-equiv='X-UA-Compatible' content='IE=Edge' />
    <meta charset='UTF-8'>
    <title>Maps SDK for Web - Entity type filtering</title>
    <meta name='viewport'
          content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <link rel='stylesheet' type='text/css' href='../sdk/maps.css'/>
    <link rel='stylesheet' type='text/css' href='../pages/examples/styles/main.css'/>
</head>
<body>
    <script data-showable type="text/javascript" src='../pages/examples/assets/js/foldable.js'></script>
    <script data-showable type="text/javascript" src='../pages/examples/assets/js/info-hint.js'></script>
    <script data-showable type="text/javascript" src='../pages/examples/assets/js/validators.js'></script>
    <script data-showable type="text/javascript" src='../pages/examples/assets/js/search/languages.js'></script>
    <script data-showable type='text/javascript' src='../pages/examples/assets/js/mobile-or-tablet.js'></script>
    <script type="text/javascript" src="../pages/examples/styles/tail.select.min.js"></script>
    <div id='map' class='map'>
        <div class='tt-overlay-panel -left-top -medium js-foldable'>
            <form>
                <label class='tt-form-label'>Language
                    <select class='js-language-select tt-select'></select>
                </label>
                <div class='tt-inline-input-group tt-spacing-top-24'>
                    <label class='tt-form-label'>Latitude
                        <input
                            class='tt-input js-latitude-input'
                            placeholder='e.g. 51.686'
                            maxlength="6"/>
                    </label>
                    <label class='tt-form-label'>Longitude
                        <input
                            class='tt-input js-longitude-input'
                            placeholder='e.g. 19.640'
                            maxlength="6"/>
                    </label>
                </div>
                <span class='tt-hint-text tt-spacing-top-12'>
                    *Type or click on the map to select a location.
                </span>
                <label class='tt-form-label tt-spacing-top-24'>Entity type
                    <select class='js-entity-type-select tt-select' multiple>
                        <option>Country</option>
                        <option>CountrySecondarySubdivision</option>
                        <option>CountryTertiarySubdivision</option>
                        <option>Municipality</option>
                        <option>MunicipalitySubdivision</option>
                        <option>Neighbourhood</option>
                        <option>Neighbourhood</option>
                        <option>PostalCodeArea</option>
                    </select>
                </label>
                <div class='tt-spacing-top-12'>
                        <div class='js-filters-container tt-filters-container'></div>
                    </div>
            </form>
        </div>
    </div>
    <script src='../sdk/maps-web.min.js'></script>
    <script src='../sdk/services-web.min.js'></script>
    <script>
        tt.setProductInfo('<your-product-name>', '<your-product-version>');
        var map = tt.map({
            key: '${api.key}',
            container: 'map',
            style: 'tomtom://vector/1/basic-main',
            center: [4.899431, 52.379189],
            zoom: 13,
            dragPan: !window.isMobileOrTablet()
        });

        map.addControl(new tt.FullscreenControl());
        map.addControl(new tt.NavigationControl());

        var entityTypeSelect = tail.select('.js-entity-type-select', {
            classNames: 'tt-fake-select',
            placeholder: 'Add filters from the list',
            multiShowCount: false,
            hideSelected: true,
            multiContainer: '.js-filters-container'
        });

        var languageSelect = tail.select('.js-language-select', {
            classNames: 'tt-fake-select',
            hideSelected: true
        });

        function EntityTypeFiltering() {
            this.errorHint = new InfoHint('error', 'bottom-center', 5000)
                .addTo(document.getElementById('map'));

            this.initState();
            this.bindElements();

            this.getLanguages();

            this.bindEvents();
        }

        EntityTypeFiltering.prototype.initState = function() {
            this.state = {
                searchLanguage: 'en-US',
                entityType: [],
                position: {
                    latitude: null,
                    longitude: null
                },
                isRequesting: false
            };
        };

        EntityTypeFiltering.prototype.bindElements = function() {
            var latitudeInput = document.querySelector('.js-latitude-input');
            var longitudeInput = document.querySelector('.js-longitude-input');

            this.elements = {
                entityTypeSelect: entityTypeSelect,
                languageSelect: languageSelect,
                latitudeInput: latitudeInput,
                longitudeInput: longitudeInput
            };
        };

        EntityTypeFiltering.prototype.bindEvents = function() {
            this.elements.languageSelect.on('change', this.setActiveLanguage.bind(this));
            this.elements.entityTypeSelect.on('change', this.updateSelectedEntities.bind(this));
            this.elements.latitudeInput.addEventListener('change', function(event) {
                this.updatePosition([undefined, event.target.value]);
            }.bind(this));
            this.elements.longitudeInput.addEventListener('change', function(event) {
                this.updatePosition([event.target.value, undefined]);
            }.bind(this));

            map.on('click', this.handleMapClick.bind(this));
        };

        EntityTypeFiltering.prototype.updatePosition = function(pos) {
            let isOk = true;

            const longitude = pos[0] || this.state.position.longitude;
            const latitude = pos[1] || this.state.position.latitude;

            try {
                validators.checkLongitude(longitude);
                this.state.position.longitude = longitude;
            } catch (error) {
                this.errorHint.setMessage(error.message);
                this.removePopup();

                isOk = false;
            }

            try {
                validators.checkLatitude(latitude);
                this.state.position.latitude = latitude;
            } catch (error) {
                this.errorHint.setMessage(error.message);
                this.removePopup();

                isOk = false;
            }

            if (isOk) {
                this.handleRequest();
            }
        };

        EntityTypeFiltering.prototype.setActiveLanguage = function(selected) {
            this.state.searchLanguage = selected.key;

            this.handleRequest();
        }

        EntityTypeFiltering.prototype.updateSelectedEntities = function(selected) {
            var value = selected.value;
            var itemIndex = this.state.entityType.indexOf(value);

            if (itemIndex > -1) {
                this.state.entityType.splice(itemIndex, 1);
            } else {
                this.state.entityType.push(value);
            }

            this.handleRequest();
        };

        EntityTypeFiltering.prototype.getLanguages = function() {
            var languages = this.mapLanguages(window.searchLanguages);

            this.elements.languageSelect.options.add(languages);
            this.elements.languageSelect.options.select(this.state.searchLanguage, '#');
        };

        EntityTypeFiltering.prototype.getReverseGeocodeService = function() {
            return tt.services.reverseGeocode({
                key: '${api.key.search}',
                position: [
                    this.state.position.longitude,
                    this.state.position.latitude
                ],
                language: this.state.searchLanguage,
                entityType: this.state.entityType.join() || undefined
            });
        };

        EntityTypeFiltering.prototype.requestData = function() {
            if (this.state.isRequesting) {
                return;
            }

            this.state.isRequesting = true;
            this.getReverseGeocodeService()
                .go()
                .then(this.handleResponse.bind(this))
                .catch(this.handeError)
                .finally(function() {
                    this.state.isRequesting = false;
                }.bind(this));
        };

        EntityTypeFiltering.prototype.handleResponse = function(response) {
            var address = response.addresses[0];
            var popupContent;

            if (address) {
                var freeFormAddress = document.createElement('strong');
                var freeformAddress = address.address.freeformAddress;
                freeFormAddress.innerText = address.address.freeformAddress;

                popupContent = freeFormAddress.outerHTML;

                if (address.entityType) {
                    var entityType = document.createElement('div');
                    entityType.innerText = '(Entity type: ' + address.entityType + ')';

                    popupContent += entityType.outerHTML;
                }
            }

            this.popup.setHTML(popupContent || 'No data found for given parameters.');
        }

        EntityTypeFiltering.prototype.setPopup = function(lngLat) {
            this.popup = new tt.Popup({ className: 'tt-popup' })
                .setLngLat(new tt.LngLat(this.state.position.longitude, this.state.position.latitude))
                .setHTML('Loading...');

            this.popup.addTo(map);

            var markerElement = document.createElement('div');
            markerElement.setAttribute('class', 'tt-marker -start');

            this.marker = new tt.Marker(markerElement)
                .setLngLat(new tt.LngLat(this.state.position.longitude, this.state.position.latitude))

            this.marker.addTo(map);
        };

        EntityTypeFiltering.prototype.removePopup = function() {
            if (this.marker && this.popup) {
                this.marker.remove();
                this.marker = null;

                this.popup.remove();
                this.popup = null;
            }
        };

        EntityTypeFiltering.prototype.handleMapClick = function(event) {
            if (event.originalEvent.target.classList.contains('tt-marker')) {
                this.popup.addTo(map);
            }

            var lngLat = event.lngLat.toArray();
            this.elements.latitudeInput.value = parseFloat(lngLat[1]).toFixed(3);
            this.elements.longitudeInput.value = parseFloat(lngLat[0]).toFixed(3);

            this.updatePosition([lngLat[0], lngLat[1]]);
        }

        EntityTypeFiltering.prototype.handleRequest = function() {
            if (!this.state.position.latitude || !this.state.position.longitude) {
                return;
            }
            map.panTo([
                this.state.position.longitude,
                this.state.position.latitude
            ]);

            this.removePopup();
            this.setPopup();

            this.requestData();
        };

        EntityTypeFiltering.prototype.mapLanguages = function(languages) {
            var mappedLanguages = {};
            for (var langCode in languages) {
                var lang = languages[langCode];
                mappedLanguages[langCode] = {
                    key: langCode,
                    value: lang
                };
            }

            return mappedLanguages;
        };

        new EntityTypeFiltering();
        new Foldable('.js-foldable', 'top-right');
    </script>
</body>
</html>
